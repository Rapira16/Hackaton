<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .ml-section { background-color: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .model-active { color: green; font-weight: bold; }
        .model-inactive { color: red; }
        .btn { padding: 5px 10px; margin: 2px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; border: none; }
        .btn-success { background-color: #28a745; color: white; border: none; }
        .btn-danger { background-color: #dc3545; color: white; border: none; }
    </style>
</head>
<body>
<h1>Transactions</h1>
<table border="1">
<tr><th>Correlation ID</th><th>Sender</th><th>Receiver</th><th>Amount</th><th>Status</th><th>Alerts</th></tr>
{% for tx in transactions %}
<tr>
<td>{{tx.correlation_id}}</td>
<td>{{tx.sender_account}}</td>
<td>{{tx.receiver_account}}</td>
<td>{{tx.amount}}</td>
<td>{{tx.status}}</td>
<td>{{tx.alerts}}</td>
</tr>
{% endfor %}
</table>

<h1>Rules</h1>
<table border="1">
<tr><th>ID</th><th>Name</th><th>Type</th><th>Enabled</th><th>Params</th></tr>
{% for rule in rules %}
<tr>
<td>{{rule.id}}</td>
<td>{{rule.name}}</td>
<td>{{rule.rule_type}}</td>
<td>{{rule.enabled}}</td>
<td>{{rule.params}}</td>
</tr>
{% endfor %}
</table>

<div class="ml-section">
    <h1>ML Models Management</h1>
    <p><strong>Total Models:</strong> {{ ml_status.total_models }} | <strong>Active:</strong> {{ ml_status.active_count }}</p>
    
    <table>
        <tr>
            <th>Model ID</th>
            <th>Type</th>
            <th>Version</th>
            <th>Status</th>
            <th>Threshold</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
        {% for model_id, model_config in ml_status.models.items() %}
        <tr>
            <td>{{ model_id }}</td>
            <td>{{ model_config.type }}</td>
            <td>{{ model_config.version }}</td>
            <td>
                {% if model_config.active %}
                    <span class="model-active">ACTIVE</span>
                {% else %}
                    <span class="model-inactive">INACTIVE</span>
                {% endif %}
            </td>
            <td>{{ model_config.threshold }}</td>
            <td>{{ model_config.description }}</td>
            <td>
                {% if not model_config.active %}
                    <button class="btn btn-success" onclick="switchModel('{{ model_id }}')">Activate</button>
                {% else %}
                    <button class="btn btn-danger" onclick="deactivateModel('{{ model_id }}')">Deactivate</button>
                {% endif %}
                <button class="btn btn-primary" onclick="editModel('{{ model_id }}')">Edit</button>
            </td>
        </tr>
        {% endfor %}
    </table>
    
    <h3>Add New Model</h3>
    <form id="addModelForm">
        <table>
            <tr>
                <td>Model ID:</td>
                <td><input type="text" name="model_id" required></td>
            </tr>
            <tr>
                <td>Type:</td>
                <td>
                    <select name="type" onchange="toggleModelType()">
                        <option value="local">Local (pickle)</option>
                        <option value="rest">REST API</option>
                    </select>
                </td>
            </tr>
            <tr id="localPathRow">
                <td>Model Path:</td>
                <td><input type="text" name="path" placeholder="models/model.pkl"></td>
            </tr>
            <tr id="restUrlRow" style="display:none;">
                <td>REST URL:</td>
                <td><input type="text" name="url" placeholder="http://ml-service:8080/predict"></td>
            </tr>
            <tr>
                <td>Version:</td>
                <td><input type="text" name="version" value="1.0.0"></td>
            </tr>
            <tr>
                <td>Threshold:</td>
                <td><input type="number" name="threshold" step="0.01" min="0" max="1" value="0.8"></td>
            </tr>
            <tr>
                <td>Description:</td>
                <td><input type="text" name="description" placeholder="Model description"></td>
            </tr>
            <tr>
                <td colspan="2">
                    <button type="submit" class="btn btn-primary">Add Model</button>
                </td>
            </tr>
        </table>
    </form>
</div>

<script>
function toggleModelType() {
    const type = document.querySelector('select[name="type"]').value;
    const localRow = document.getElementById('localPathRow');
    const restRow = document.getElementById('restUrlRow');
    
    if (type === 'local') {
        localRow.style.display = '';
        restRow.style.display = 'none';
    } else {
        localRow.style.display = 'none';
        restRow.style.display = '';
    }
}

function switchModel(modelId) {
    fetch('/admin/ml/switch', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model_id: modelId})
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error switching model');
        }
    });
}

function deactivateModel(modelId) {
    fetch('/admin/ml/deactivate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model_id: modelId})
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deactivating model');
        }
    });
}

function editModel(modelId) {
    // Простая реализация редактирования через prompt
    const newThreshold = prompt('Enter new threshold (0.0-1.0):');
    if (newThreshold !== null && !isNaN(newThreshold)) {
        fetch('/admin/ml/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                model_id: modelId,
                threshold: parseFloat(newThreshold)
            })
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error updating model');
            }
        });
    }
}

document.getElementById('addModelForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const modelData = {};
    
    for (let [key, value] of formData.entries()) {
        if (value) modelData[key] = value;
    }
    
    fetch('/admin/ml/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(modelData)
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error adding model');
        }
    });
});
</script>
</body>
</html>
